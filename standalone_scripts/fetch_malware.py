import requests
import subprocess
import pyzipper


def main():
    api_base = "https://mb-api.abuse.ch/api/v1"

    pre_query = {
            "query": "get_recent",
            "selector": 100
    }

    # gather malware samples from the source

    req = requests.post(api_base, data=pre_query)
    data = req.json()["data"]
    hashes = [entry["sha256_hash"] for entry in data if entry["sha256_hash"] != ""]

    # create queries for the API call

    download_queries = []
    for entry in hashes:
        download_query = {
                "query": "get_file",
                "sha256_hash": ""
        }
        download_query["sha256_hash"] = entry
        download_queries.append(download_query)

    # download malware samples

    counter = 0
    for query in download_queries:
        req = requests.post(api_base, data=query)
        with open("samples/file_{}".format(counter), "wb") as sample:
            sample.write(req.content)
            print("{} has been downloaded".format(query["sha256_hash"]))
        counter+=1

    # unzip stored samples

    zip_passwd = b'infected'
    counter = 0
    while len(download_queries) > counter:
        with pyzipper.AESZipFile("samples/file_{}".format(counter)) as sample:
            sample.pwd = zip_passwd
            sample.extractall("unzipped")
            print("{} has been unzipped".format(query["sha256_hash"]))
        counter+=1


if __name__ == "__main__":
    main()
